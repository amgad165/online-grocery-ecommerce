<script>
    document.addEventListener('DOMContentLoaded', function() {
        var stripe = Stripe('{{STRIPE_PUBLIC_KEY}}');
        var elements = stripe.elements();
        var card;

        $('#stripeModal').on('shown.bs.modal', function () {
            fetch('/load_modal_data/').then(response => response.json()).then(data => {
        if (data.error) {
            console.error(data.error);
        } else {

            sidebar.style.right='-1000px';
            // document.getElementById('product-details').textContent = data.product_details;
            document.getElementById('total-price').textContent = `Total Price: €${data.total_price.toFixed(2)}`;
        }
    });
            if (!card) { // Initialize the card only once
                card = elements.create('card');
                card.mount('#card-element');
            }
    
            document.getElementById('payment-form').addEventListener('submit', function(event) {
                event.preventDefault();
                stripe.createPaymentMethod({
                    type: 'card',
                    card: card,
                }).then(function(result) {
                    if (result.error) {
                        var errorElement = document.getElementById('card-errors');
                        errorElement.textContent = result.error.message;
                    } else {
                        stripePaymentMethodHandler(result.paymentMethod.id);
                    }
                });
            });
        });
    
function stripePaymentMethodHandler(paymentMethodId) {
    const csrftoken = getCookie('csrftoken');
    fetch('/create_subscription/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({paymentMethodId: paymentMethodId})
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        if (data.error) {
            console.error(data.error);
            alert('Failed to create subscription: ' + data.error);
            window.location.href = '/failed_page/';
        } else {
            console.log('Subscription created:', data);
            alert('Subscription created successfully!');
            window.location.href = '/success_page/';  // Redirect to a success page
        }
    }).catch(function(error) {
        console.error('Fetch error:', error);
        alert('Error processing your subscription.');
    });
}
    });
    </script>
    <script>

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.startsWith(name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
        }
    </script>
    <!-- update cart -->
    <script>
      function updateQuantity(itemId, action) {
          // Get the current quantity from the quantity div
          var quantityElement = $('#quantity_' + itemId);
          var order_total_span = $('#order_total')
          var product_price = $('#product_price_'+itemId)
          var item_weight_element = $('#item_weight_'+itemId)
          var quantity = parseInt(quantityElement.text().trim());
          
          if (action === 'increment') {
              quantity += 1;
              
          } else if (action === 'decrement' && quantity > 1) {
              quantity -= 1;
          }
      
          // Make an AJAX request to update the cart
          $.ajax({
              type: 'POST',
              url: '{% url 'update_cart' %}',
              data: {
                  item_id: itemId,
                  quantity: quantity,
                  action: action , 
                  'csrfmiddlewaretoken': '{{ csrf_token }}'
              },
              success: function(response) {
                  // Handle success response if needed
                  console.log('Cart updated successfully');
      
                  console.log(response.order_total)
                  quantityElement.text(quantity);
                  product_price.text(response.product_price.toFixed(1)+ " € ")
                  order_total_span.text("€ "+ response.order_total.toFixed(1) + " EUR");
                  item_weight_element.text(" "+response.item_weight + " kg")


                  var totalQuantity = response.cart_items_count;
                $('.cart-badge').text(totalQuantity).show().animate({
                    fontSize: '16px',
                }, 200).animate({
                    fontSize: '12px',
                }, 200);
              },
              error: function(xhr, status, error) {
                  // Handle error if AJAX request fails
                  console.error('Error updating cart:', error);
              }
          });
      }
      </script>
      
      
<script>
    $(document).ready(function() {
        


    $('.remove').on('click', function(e) {
        e.preventDefault();
        var order_total_span = $('#order_total')

        var product_id = $(this).data('product-id');
    var data = {
    product_id: product_id,
    'csrfmiddlewaretoken': '{{ csrf_token }}'        
        };

        $.ajax({
            type: 'POST',
            url: '{% url "remove_item" %}',
    data: data,
    
        success: function(data) {
            // Update the total price
            var total_price = parseFloat(data.order_total);
    
            // $('#final-total').text('€ ' + total_price.toFixed(1));
            order_total_span.text("€ "+ total_price.toFixed(1) + " EUR");

            var totalQuantity = data.cart_items_count;
            console.log('removed')
            // Display the badge and animate it
            $('.cart-badge').text(totalQuantity).show().animate({
                fontSize: '16px',
                }, 200).animate({
                fontSize: '12px',
                }, 200);
    
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseText);
                    }
                });
            });
        });
      </script>
      