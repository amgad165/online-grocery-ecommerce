{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />


    {% include 'include/links.html' %}

    <title>Products</title>
  </head>
  <body>
    
    {% include 'include/nav.html' %}


<!-- side bar -->

    {% include 'include/aside.html' %}



      <!-- Modal -->
      <div class="modal fade" id="stripeModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Checkout</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="payment-form">
                  <!-- <div id="product-details"></div>   -->
                  <div id="total-price"></div>  
                  <div id="card-element"></div>
                  <div id="card-errors" role="alert"></div>
                  <button id="submit-button" type="submit" class="btn btn-primary mt-4">Submit Payment</button>
              </form>
          </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      {% if user.role == "private" %}

    
      <section id="priv-products" class="bg-third-color">
        <div class="container">
          <div class="row g-5 p-5">
            <h1 class="text-center text-color-green-dark my-5">Unsere Produkte  <br>
              <span class="under-heading">  - PRIVAT -</span>

            </h1>

            
            {% for product in privat_products %}
     
          
              
            <div class="col-md-6 col-lg-4 p-3">
              <div class="bg-white p-4 h-100">
                <img
                  src="{{ product.image.url }}"
                  class="w-100 translated-img"
                  alt=""
                />
                <p class="fs-6 fw-semibold">
                      {{product.description}}
                </p>
                <a href="" class="btn btn-orange d-block m-auto" data-bs-toggle="modal" data-bs-target="#exampleModal{{ product.id }}"
                  >Jetzt Bestellen</a
                >
              </div>
            </div>





<!-- modal for product detials  -->

    <!-- modal details box -->
    <div class="modal product-details-modal fade modal-xl" id="exampleModal{{ product.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">

      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-body">
            <div id="alert-container" class="alert alert-danger alert-dismissible " style="display: none;">
            </div>

            <div class="row p-3 details-box">
              <div class="d-flex justify-content-between">
                <h1>Konfiguriere deine Box</h1>
                <i class="fa-solid fa-x pointer-cursor" data-bs-dismiss="modal"></i>
              </div>
              <div class="size-selection">
                <button type="button" class="btn btn-outline-primary size-btn" data-max-quantity="5" data-size="S">S</button>
                <button type="button" class="btn btn-outline-primary size-btn" data-max-quantity="10" data-size="M">M</button>
                <button type="button" class="btn btn-outline-primary size-btn" data-max-quantity="15" data-size="L">L</button>
                <p id="size-info" class="text-muted"></p>
              </div>

              <div class="col-12 col-lg-6 mt-4  p-3 p-lg-5 ">
                <div class="row gap-4"> 
                {% for product_ingredient in product.ingredients.all %}
                <div class="row m-0 p-0"> 
                  <div class="col-6">
                      <div class="ingredient-details">
                        {% if product.customize %}
                          <input type="checkbox" class="ingredient-checkbox" data-ingredient-id="{{ product_ingredient.ingredient.id }}">

                          {% else %}
                          <i class="fa-solid fa-square me-2"></i>
                          <input hidden checked type="checkbox" class="ingredient-checkbox" data-ingredient-id="{{ product_ingredient.ingredient.id }}">

                          {% endif %}
                          {{ product_ingredient.ingredient }}
                      </div>
                  </div>
                  <!-- Hidden input field for ingredient price -->
                  <input type="hidden" class="ingredient-price" value="{{ product_ingredient.ingredient.price }}">
                  <div class="col-6 d-flex justify-content-end">
                      <div class="d-flex gap-3">
                          {% if product.customize %}
                              <div class="minus circled minus-icon" >
                                  <i class="fa-solid fa-minus"></i>
                              </div>
                          {% endif %}
                          <div class="quantity">
                              <span id="product-quantity_{{ product_ingredient.ingredient.id }}">{{ product_ingredient.quantity }}</span>
                          </div>
                          {% if product.customize %}
                              <div class="plus circled plus-icon">
                                  <i class="fa-solid fa-plus"></i>
                              </div>
                          {% endif %}
                          <span class="fw-bold">Kg</span>
                      </div>
                  </div>
              </div>
                                  
                {% endfor %}
                  

                
              
              </div>
            </div>
              
              <div class="col-12 col-lg-6 mt-4 mt-lg-3  p-3 p-lg-5 border-left"><div>
                <h2 class="mt-4 mt-lg-0">Summe:</h2>
                <p class="mb-4">Lorem ipsum dolor sit amet, consectetuer
                  adipiscing elit, sed diam nonummy nibh
                  euismod tincidunt ut laoreet dolore
                  magna aliquam erat volutpat. Ut wisi enim
                  ad minim veniam, quis nostrud exerci
                  tation ullamcorper suscipit lobortis nisl ut
                  aliquip ex ea commodo consequat. Duis</p>
                  <h2>Lieferung</h2>
                  <p class="mb-4">Lorem ipsum dolor sit amet, consectetuer
                    adipiscing elit, sed diam nonummy nibh
                    euismod tincidunt ut laoreet dolore
                    magna aliquam erat volutpat.</p>
                    <div class="mb-4 d-flex justify-content-between">
                      <span class="h5">Summe</span>
                      {% if product.customize %}
                      <span id="total-price" class="fw-bold">{{ product.calculate_total_cost }}€</span>

                     {% else %}
                     <span  class="fw-bold">{{ product.price }}€</span>

                      {% endif %}
                        
                    </div>
                    <div class=" text-center">


                      <button data-item-id="{{ product.id }}" class="btn btn-orange add-to-cart-button">In den Warenkorb</button>
                    </div>
              </div></div>
            </div>
          </div>
       
        </div>
      </div>
    </div>

            {% endfor %}


              <!-- <div class="col bg-white rounded-5">
                <div>
                  
                </div>
              </div> -->
          </div>
        </div>
      </section>
      {% else %}
     
      <section id="firm-products" class="bg-third-color">
        <div class="container">
          <div class="row g-5 p-5">
            <h1 class="text-center  text-color-green-dark my-5">Unsere Produkte  <br>
              <span class="fs-5">  - BUSINESS -</span>
            </h1>
            
            {% for product in business_products %}
              
            
              
            <div class="col-md-6 col-lg-4 p-3">
              <div class="bg-white p-4 h-100">
                <img
                  src="{{ product.image.url }}"
                  class="w-100 translated-img"
                  alt=""
                />
                <p class="fs-6 fw-semibold">
                      {{product.description}}
                </p>
                <a href="" class="btn btn-orange d-block m-auto" data-bs-toggle="modal" data-bs-target="#exampleModal{{ product.id }}"
                  >Jetzt Bestellen</a
                >
              </div>
            </div>





<!-- modal for product detials  -->

    <!-- modal details box -->
    <div class="modal product-details-modal fade modal-xl" id="exampleModal{{ product.id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">

      <div class="modal-dialog">
        <div class="modal-content">

          <div class="modal-body">
            <div id="alert-container" class="alert alert-danger alert-dismissible " style="display: none;">
            </div>

            <div class="row p-3 details-box">
              <div class="d-flex justify-content-between">
                <h1>Konfiguriere deine Box</h1>
                <i class="fa-solid fa-x pointer-cursor" data-bs-dismiss="modal"></i>
              </div>

              <div class="col-lg-6 mt-4  p-5 ">
                <div class="row gap-4"> 
                {% for product_ingredient in product.ingredients.all %}
                <div class="row m-0 p-0">
                  <div class="col-6">
                      <div>
                        {% if product.customize %}
                          <input type="checkbox" class="ingredient-checkbox" data-ingredient-id="{{ product_ingredient.ingredient.id }}">

                          {% else %}
                          <i class="fa-solid fa-square me-2"></i>
                          <input hidden checked type="checkbox" class="ingredient-checkbox" data-ingredient-id="{{ product_ingredient.ingredient.id }}">

                          {% endif %}
                          {{ product_ingredient.ingredient }}
                      </div>
                  </div>
                  <!-- Hidden input field for ingredient price -->
                  <input type="hidden" class="ingredient-price" value="{{ product_ingredient.ingredient.price }}">
                  <div class="col-6 d-flex justify-content-end">
                      <div class="d-flex gap-3">
                          {% if product.customize %}
                              <div class="minus circled minus-icon" >
                                  <i class="fa-solid fa-minus"></i>
                              </div>
                          {% endif %}
                          <div class="quantity">
                              <span id="product-quantity_{{ product_ingredient.ingredient.id }}">{{ product_ingredient.quantity }}</span>
                          </div>
                          {% if product.customize %}
                              <div class="plus circled plus-icon">
                                  <i class="fa-solid fa-plus"></i>
                              </div>
                          {% endif %}
                          <span class="fw-bold">Kg</span>
                      </div>
                  </div>
              </div>
                                  
                {% endfor %}
                  

                
              
              </div>
            </div>
              
              <div class="col-lg-6 mt-4  p-5 border-left"><div>
                <h2>Summe:</h2>
                <p class="mb-4">Lorem ipsum dolor sit amet, consectetuer
                  adipiscing elit, sed diam nonummy nibh
                  euismod tincidunt ut laoreet dolore
                  magna aliquam erat volutpat. Ut wisi enim
                  ad minim veniam, quis nostrud exerci
                  tation ullamcorper suscipit lobortis nisl ut
                  aliquip ex ea commodo consequat. Duis</p>
                  <h2>Lieferung</h2>
                  <p class="mb-4">Lorem ipsum dolor sit amet, consectetuer
                    adipiscing elit, sed diam nonummy nibh
                    euismod tincidunt ut laoreet dolore
                    magna aliquam erat volutpat.</p>
                    <div class="mb-4 d-flex justify-content-between">
                      <span class="h5">Summe</span>
                      {% if product.customize %}
                      <span id="total-price" class="fw-bold">{{ product.calculate_total_cost }}€</span>

                     {% else %}
                     <span  class="fw-bold">{{ product.price }}€</span>

                      {% endif %}
                        
                    </div>
                    <div class=" text-center">


                      <button data-item-id="{{ product.id }}" class="btn btn-orange add-to-cart-button">In den Warenkorb</button>
                    </div>
              </div></div>
            </div>
          </div>
       
        </div>
      </div>
    </div>
            {% endfor %}


          </div>
        </div>
      </section>
      {% endif %}
    </main>


    {% include 'include/footer.html' %}

    {% include 'include/scripts.html' %}

    <script src="{% static 'Js/products.js' %}"></script>
    <script src="{% static 'Js/custom.js' %}"></script>

    <script src="https://js.stripe.com/v3/"></script>
    

    {% include 'include/ajax_functions.html' %}

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const sizeButtons = document.querySelectorAll('.size-btn');
        const sizeInfo = document.getElementById('size-info');
    
        sizeButtons.forEach(button => {
          button.addEventListener('click', function() {
            const maxQuantity = this.getAttribute('data-max-quantity');
            const size = this.getAttribute('data-size');
            sizeInfo.textContent = `For size ${size}, maximum quantity is ${maxQuantity} kilos.`;
          });
        });
      });
    </script>



  <script>
     
// Add to cart
$(document).ready(function() {
    $('.add-to-cart-button').click(function() {
      var modal = $(this).closest('.modal');
      var itemId = $(this).data('item-id');
      var ingredientQuantities = {};

      modal.find('.ingredient-checkbox:checked').each(function() {
          var ingredientId = $(this).data('ingredient-id');
          var quantity = $(this).closest('.row').find('.quantity span').text().trim();
          ingredientQuantities[ingredientId] = parseInt(quantity);

          console.log(ingredientQuantities)
      });


        var data = {
            id: itemId,
            ingredient_quantities: JSON.stringify(ingredientQuantities), // Send ingredient quantities as JSON
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        };

        $.ajax({
            type: 'POST',
            url: '{% url 'add_to_cart' %}',
            data: data,
            success: function(response) {
                var totalQuantity = response.cart_items_count;
                $('.cart-badge').text(totalQuantity).show().animate({
                    fontSize: '16px',
                }, 200).animate({
                    fontSize: '12px',
                }, 200);
                alert('Product added to cart successfully');
                location.reload(); // Refresh the page after adding to cart
            },
            error: function(xhr) {
              var errorResponse = JSON.parse(xhr.responseText);
              var errorMessage = errorResponse.error;

              var alertContainer = modal.find('#alert-container');
              alertContainer.empty(); // Clear previous content
              alertContainer.append(errorMessage + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
              alertContainer.show();
      }
        });
    });

});


    </script>



  



  </body>
</html>
